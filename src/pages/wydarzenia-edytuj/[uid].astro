---
import Layout from '../../layouts/Layout.astro';
import PageHeader from '../../components/PageHeader.astro';
import ConfirmModal from '../../components/ConfirmModal.astro';
import EventForm from '../../components/EventForm.astro';
import { events } from '../../data/events';

export async function getStaticPaths() {
  return events.map(event => ({
    params: { uid: event.uid },
    props: { event },
  }));
}

const { event } = Astro.props;

const formatDate = (dateString) => {
  const [day, month, year] = dateString.split('/').map(Number);
  const dateObj = new Date(year, month - 1, day);
  
  return new Intl.DateTimeFormat('pl-PL', { day: 'numeric', month: 'long', year: 'numeric' }).format(dateObj);
};
---

<Layout title={`Zatyrani - Edytuj Wydarzenie: ${event.title}`}>
  <PageHeader
    title="Edytuj Wydarzenie"
    subtitle="Usuń lub zmodyfikuj istniejące wydarzenie."
  />

  <div id="view-mode" class="max-w-2xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
    <div class="bg-white shadow-md rounded-lg p-6">
      <h2 class="text-2xl font-bold mb-4">{event.title}</h2>
      <p class="text-gray-700 mb-2"><strong>Data:</strong> {formatDate(event.date)}</p>
      <p class="text-gray-700 mb-4"><strong>Lokalizacja:</strong> {event.location}</p>
      <p class="text-gray-700 mb-4"><strong>Opis:</strong> {event.description}</p>
      <p class="text-gray-700 mb-4"><strong>UID:</strong> {event.uid}</p>

      <button
        id="delete-event-button"
        class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline"
      >
        Usuń wydarzenie
      </button>

      <button
        id="edit-event-button"
        class="ml-4 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline inline-block"
      >
        Edytuj wydarzenie
      </button>

      <a
        href="/wydarzenia"
        class="ml-4 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full focus:outline-none focus:shadow-outline inline-block"
      >
        Wróć
      </a>

      <div id="message" class="mt-4 text-center"></div>
    </div>
  </div>

  <div id="edit-mode" class="hidden">
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
      <p>
          Wypełnij poniższy formularz, aby zaktualizować wydarzenie. Pamiętaj, że wszystkie pola oznaczone gwiazdką <span class="text-red-600">*</span> są obowiązkowe.
      </p>
    </div>
    <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 mt-0 mb-4">
      <hr class="my-4 border-t border-gray-300" />
    </div>
    
    <EventForm event={event} />
  </div>

  <ConfirmModal
    title="Potwierdzenie usunięcia"
    message={`Czy na pewno chcesz usunąć wydarzenie: ${event.title}?`}
  />

  <script define:vars={{ uid: event.uid }}>
    const modal = document.getElementById('confirm-modal');
    const confirmButton = document.getElementById('confirm-button');
    const cancelButton = document.getElementById('cancel-button');
    const messageDiv = document.getElementById('message');
    const viewMode = document.getElementById('view-mode');
    const editMode = document.getElementById('edit-mode');
    const editButton = document.getElementById('edit-event-button');

    document.getElementById('delete-event-button').addEventListener('click', () => {
      modal.classList.remove('hidden');
    });

    cancelButton.addEventListener('click', () => {
      modal.classList.add('hidden');
    });

    confirmButton.addEventListener('click', async () => {
      modal.classList.add('hidden');

      try {
        const response = await fetch(`/api/delete-event`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ uid }),
        });

        const data = await response.json();

        if (response.ok) {
          messageDiv.className = 'text-green-600';
          messageDiv.textContent = data.message || 'Wydarzenie usunięte pomyślnie!';
          setTimeout(() => {
            window.location.href = '/wydarzenia'; // Redirect after successful deletion
          }, 2000);
        } else {
          messageDiv.className = 'text-red-600';
          messageDiv.textContent = data.error || 'Wystąpił błąd podczas usuwania wydarzenia.';
        }
      } catch (error) {
        console.error('Błąd:', error);
        messageDiv.className = 'text-red-600';
        messageDiv.textContent = 'Wystąpił błąd sieci lub serwera.';
      }
    });

    editButton.addEventListener('click', () => {
      viewMode.classList.add('hidden');
      editMode.classList.remove('hidden');
    });
  </script>
</Layout>