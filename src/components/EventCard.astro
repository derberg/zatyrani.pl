---
import type { Events } from "../data/events";
import { formatDateDisplay } from "../utils/events.js";

type Props = Events & { assignedFallbackImage?: string };

const {
  title,
  location,
  date,
  description,
  image,
  mainLink,
  registrationLink,
  uid,
  assignedFallbackImage,
} = Astro.props;

// Use provided fallback image or the event's image
const displayImage = image || assignedFallbackImage;
---

<article
  class="bg-white rounded-lg shadow-md overflow-hidden hover:shadow-lg transition-shadow flex flex-col"
>
  <div class="p-6 flex-grow space-y-4">
    <div class="flex items-center space-x-4">
      <img
        id="event-image"
        src={displayImage}
        alt={title}
        class="w-16 h-16 object-contain"
      />
      <h3 class="text-xl font-bold">{title}</h3>
    </div>
    <div class="space-y-2 text-gray-600 mt-4">
      <p class="font-bold">
        {formatDateDisplay(date)}
        <span
          class="inline-block px-2 py-1 text-xs font-semibold text-green-600 bg-green-100 rounded-full"
        >
          {location}
        </span>
      </p>

      <hr class="my-4 border-t border-gray-300" />
      <p>{description}</p>
    </div>
  </div>
  <div class="flex justify-center space-x-4 items-end p-6">
    {
      mainLink && (
        <a
          href={mainLink}
          target="_blank"
          rel="noopener noreferrer"
          class="text-sm text-blue-500 hover:text-blue-700"
        >
          WiÄ™cej info
        </a>
      )
    }
    <a
      href={`/wydarzenia-edytuj/${uid}`}
      class="text-sm text-purple-600 hover:text-purple-700"
      style="display: none;"
    >
      Edytuj
    </a>
    {
      registrationLink && (
        <a
          href={registrationLink}
          target="_blank"
          rel="noopener noreferrer"
          class="text-sm text-green-500 hover:text-green-700"
        >
          Rejestracja
        </a>
      )
    }
  </div>
</article>

<script>
  // Hide edit link if not logged in
  function getAuthState() {
    try {
      const raw = window.localStorage.getItem('authState');
      if (!raw) return { loggedIn: false };
      const parsed = JSON.parse(raw);
      if (!parsed || typeof parsed !== 'object') return { loggedIn: false };
      if (parsed.expiresAt && Date.now() > parsed.expiresAt) {
        window.localStorage.removeItem('authState');
        return { loggedIn: false };
      }
      return { loggedIn: !!parsed.loggedIn, expiresAt: parsed.expiresAt };
    } catch {
      return { loggedIn: false };
    }
  }

  const { loggedIn } = getAuthState();
  if (loggedIn) {
    const editLinks = document.querySelectorAll('a[href*="/wydarzenia-edytuj/"]');
    editLinks.forEach(link => (link as HTMLElement).style.display = '');
  }
</script>
