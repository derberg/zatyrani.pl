---
import RaceCategorySelector from "./RaceCategorySelector.astro";
import TshirtSizeSelector from "./TshirtSizeSelector.astro";
import RegistrationSummary from "./RegistrationSummary.astro";
import ClubAutocomplete from "./ClubAutocomplete.astro";

interface Props {
  t: (key: string) => string;
  locale?: string;
}
const { t, locale = 'pl' } = Astro.props;
---

  <div class="mx-auto max-w-4xl px-6 py-12">
    <!-- Step 1: Email Verification -->
    <div id="step1" class="space-y-6">
      <div class="text-center">
        <h2 class="text-3xl font-bold text-slate-900">{t("niebocross.registration.email_step_title")}</h2>
        <p class="mt-2 text-slate-600">{t("niebocross.registration.email_step_desc")}</p>
      </div>

      <div class="mx-auto max-w-md rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
        <form id="emailForm" class="space-y-4">
          <div>
            <label for="email" class="block text-sm font-semibold text-slate-700">
              {t("niebocross.form.email")} <span class="text-red-600">*</span>
            </label>
            <input
              type="email"
              id="email"
              name="email"
              required
              class="mt-1 block w-full rounded-lg border-emerald-300 border-2 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 px-3 py-2"
              placeholder="twoj@email.pl"
            />
          </div>

          <div>
            <label for="fullName" class="block text-sm font-semibold text-slate-700">
              {t("niebocross.form.contact_person")} <span class="text-red-600">*</span>
            </label>
            <p class="text-xs text-slate-500">{t("niebocross.form.contact_person_desc")}</p>
            <input
              type="text"
              id="fullName"
              name="fullName"
              required
              class="mt-1 block w-full rounded-lg border-emerald-300 border-2 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 px-3 py-2"
              placeholder="Jan Kowalski"
            />
          </div>

          <div class="flex items-start gap-2">
            <input
              type="checkbox"
              id="rodoAccepted"
              name="rodoAccepted"
              required
              class="mt-1 rounded border-emerald-300 border-2 text-emerald-600 focus:ring-emerald-500"
            />
            <label for="rodoAccepted" class="text-sm text-slate-700">
              {t("niebocross.form.rodo_consent")} <span class="text-red-600">*</span>
            </label>
          </div>

          <div class="flex items-start gap-2">
            <input
              type="checkbox"
              id="termsAccepted"
              name="termsAccepted"
              required
              class="mt-1 rounded border-emerald-300 border-2 text-emerald-600 focus:ring-emerald-500"
            />
            <label for="termsAccepted" class="text-sm text-slate-700">
              {t("niebocross.form.terms_consent")} <a href="https://docs.google.com/document/d/12FChbcF7rbxy0P9B1gMyn9KobLx8IgpJi365ymROYjk/edit?usp=sharing" target="_blank" class="text-emerald-600 hover:underline">{t("niebocross.form.terms_link")}</a> <span class="text-red-600">*</span>
            </label>
          </div>

          <!-- Honeypot field - hidden from humans, bots will fill it -->
          <div class="absolute -left-full -top-full opacity-0 pointer-events-none overflow-hidden h-0 w-0" aria-hidden="true">
            <label for="website">Website</label>
            <input
              type="text"
              id="website"
              name="website"
              tabindex="-1"
              autocomplete="off"
            />
          </div>

          <div id="emailError" class="hidden rounded-lg bg-red-50 p-3 text-sm text-red-700"></div>

          <button
            type="submit"
            class="w-full rounded-lg bg-emerald-600 px-6 py-3 font-semibold text-white transition hover:bg-emerald-700 disabled:bg-slate-300 disabled:cursor-not-allowed"
            id="emailSubmitBtn"
            disabled
          >
            {t("niebocross.form.send_code")}
          </button>
        </form>
      </div>
    </div>

    <!-- Step 2: Code Verification -->
    <div id="step2" class="hidden space-y-6">
      <div class="text-center">
        <h2 class="text-3xl font-bold text-slate-900">{t("niebocross.registration.code_step_title")}</h2>
        <p class="mt-2 text-slate-600">{t("niebocross.registration.code_step_desc")}</p>
      </div>

      <div class="mx-auto max-w-md rounded-xl border border-slate-200 bg-white p-6 shadow-sm">
        <form id="codeForm" class="space-y-4">
          <div>
            <label for="code" class="block text-sm font-semibold text-slate-700">
              {t("niebocross.form.verification_code")} <span class="text-red-600">*</span>
            </label>
            <input
              type="text"
              id="code"
              name="code"
              required
              maxlength="6"
              pattern="[0-9]{6}"
              class="mt-1 block w-full rounded-lg border-emerald-300 text-center text-2xl font-bold tracking-widest shadow-sm focus:border-emerald-500 focus:ring-emerald-500 px-3 py-2 border-2"
              placeholder="000000"
            />
          </div>

          <!-- Spam check info -->
          <div class="rounded-lg bg-blue-50 p-3 text-sm text-blue-700">
            <p>{t("niebocross.form.check_spam")}</p>
          </div>

          <div id="codeError" class="hidden rounded-lg bg-red-50 p-3 text-sm text-red-700"></div>
          
          <div id="codeSuccess" class="hidden rounded-lg bg-green-50 p-3 text-sm text-green-700"></div>

          <button
            type="submit"
            class="w-full rounded-lg bg-emerald-600 px-6 py-3 font-semibold text-white transition hover:bg-emerald-700 disabled:bg-slate-300 disabled:cursor-not-allowed"
            id="codeSubmitBtn"
            disabled
          >
            {t("niebocross.form.verify_code")}
          </button>

          <button
            type="button"
            id="resendCodeBtn"
            class="w-full rounded-lg border border-emerald-600 bg-white px-6 py-2 text-sm font-semibold text-emerald-600 transition hover:bg-emerald-50 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {t("niebocross.form.resend_code")}
          </button>

          <button
            type="button"
            id="backToEmail"
            class="w-full rounded-lg border border-emerald-300 border-2 bg-white px-6 py-2 text-sm font-semibold text-slate-700 transition hover:bg-slate-50"
          >
            ← {t("niebocross.form.back_to_email")}
          </button>
        </form>
      </div>
    </div>

    <!-- Step 3: Add Participants -->
    <div id="step3" class="hidden space-y-6">
      <div class="text-center">
        <h2 class="text-3xl font-bold text-slate-900">{t("niebocross.registration.participants_step_title")}</h2>
        <p class="mt-2 text-slate-600">{t("niebocross.registration.participants_step_desc")}</p>
      </div>

      <div class="grid gap-6 lg:grid-cols-[1fr_300px]">
        <div class="space-y-6">
          <form id="participantsForm" class="space-y-6">
            <div id="participantsContainer"></div>

            <button
              type="button"
              id="addParticipantBtn"
              class="rounded-lg border-2 border-dashed border-emerald-300 bg-emerald-50 px-6 py-3 font-semibold text-emerald-700 transition hover:border-emerald-400 hover:bg-emerald-100"
            >
              + {t("niebocross.form.add_participant")}
            </button>

            <div id="participantsError" class="hidden rounded-lg bg-red-50 p-3 text-sm text-red-700"></div>

            <button
              type="submit"
              class="w-full rounded-lg bg-emerald-600 px-6 py-3 font-semibold text-white transition hover:bg-emerald-700 disabled:bg-slate-300"
              id="participantsSubmitBtn"
            >
              {t("niebocross.form.proceed_to_payment")}
            </button>

            <button
              type="button"
              class="w-full rounded-lg bg-blue-600 px-6 py-3 font-semibold text-white transition hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed"
              id="finishAddingBtn"
            >
              {t("niebocross.registration.participants_step_end")}
            </button>
          </form>
        </div>

        <div class="lg:sticky lg:top-6 lg:self-start">
          <RegistrationSummary t={t} />
        </div>
      </div>
    </div>

    <!-- Step 4: Payment -->
    <div id="step4" class="hidden space-y-6">
      <div class="text-center">
        <h2 class="text-3xl font-bold text-slate-900">{t("niebocross.registration.payment_step_title")}</h2>
        <p class="mt-2 text-slate-600">{t("niebocross.registration.payment_step_desc")}</p>
      </div>

      <div class="mx-auto max-w-md rounded-xl border border-emerald-200 bg-white p-6 shadow-sm">
        <div class="mb-4 text-center">
          <div class="mx-auto mb-4 flex h-16 w-16 items-center justify-center rounded-full bg-emerald-100">
            <svg class="h-8 w-8 text-emerald-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
          </div>
          <p class="text-sm text-slate-600">{t("niebocross.registration.payment_link_sent")}</p>
        </div>

        <a
          id="paymentLink"
          href="#"
          class="block w-full rounded-lg bg-emerald-600 px-6 py-3 text-center font-semibold text-white transition hover:bg-emerald-700"
        >
          {t("niebocross.form.pay_now")}
        </a>

        <p class="mt-4 text-center text-sm text-slate-600">
          {t("niebocross.registration.or_access_later")} 
          <a href="/niebocross/panel" class="font-semibold text-emerald-600 hover:underline">
            {t("niebocross.registration.your_panel")}
          </a>
        </p>
      </div>
    </div>
  </div>

  <ClubAutocomplete />

  <script define:vars={{
    errorMessages: {
      EMAIL_EXISTS: t("niebocross.errors.email_exists"),
      EMAIL_REQUIRED: t("niebocross.errors.email_required"),
      EMAIL_INVALID: t("niebocross.errors.email_invalid"),
      RODO_REQUIRED: t("niebocross.errors.rodo_required"),
      TERMS_REQUIRED: t("niebocross.errors.terms_required"),
      INVALID_CODE: t("niebocross.errors.invalid_code"),
      INVALID_CODE_CONTACT: t("niebocross.errors.invalid_code_contact"),
      INVALID_CODE_CONTACT_LINK: t("niebocross.errors.invalid_code_contact_link"),
      CODE_EXPIRED: t("niebocross.errors.code_expired"),
      connection: t("niebocross.errors.connection_error"),
      generic: t("niebocross.errors.generic_error")
    },
    uiMessages: {
      resending: t("niebocross.form.resending"),
      resendCode: t("niebocross.form.resend_code"),
      codeResent: t("niebocross.form.code_resent")    
    },
    formLabels: {
      participant: t("niebocross.form.participant"),
      remove: t("niebocross.form.remove"),
      fullName: t("niebocross.form.full_name"),
      birthDate: t("niebocross.form.birth_date"),
      day: t("niebocross.form.day"),
      month: t("niebocross.form.month"),
      year: t("niebocross.form.year"),
      months: {
        jan: t("niebocross.form.months.jan"),
        feb: t("niebocross.form.months.feb"),
        mar: t("niebocross.form.months.mar"),
        apr: t("niebocross.form.months.apr"),
        may: t("niebocross.form.months.may"),
        jun: t("niebocross.form.months.jun"),
        jul: t("niebocross.form.months.jul"),
        aug: t("niebocross.form.months.aug"),
        sep: t("niebocross.form.months.sep"),
        oct: t("niebocross.form.months.oct"),
        nov: t("niebocross.form.months.nov"),
        dec: t("niebocross.form.months.dec")
      },
      city: t("niebocross.form.city"),
      nationality: t("niebocross.form.nationality"),
      club: t("niebocross.form.club"),
      phoneNumber: t("niebocross.form.phone_number"),
      phoneHelp: t("niebocross.form.phone_help"),
      distanceActivity: t("niebocross.form.distance_activity"),
      tshirtSize: t("niebocross.form.tshirt_size"),
      tshirtInfo: t("niebocross.form.tshirt_info"),
      noTshirt: t("niebocross.form.no_tshirt"),
      hideNamePublic: t("niebocross.form.hide_name_public"),
      kidsRunInfo: t("niebocross.form.kids_run_info"),
      categories: {
        "3km_run": t("niebocross.categories.3km_run"),
        "3km_nw": t("niebocross.categories.3km_nw"),
        "9km_run": t("niebocross.categories.9km_run"),
        "9km_nw": t("niebocross.categories.9km_nw"),
        "kids_run": t("niebocross.categories.kids_run")
      }
    }
  }}>

    // API Base URL
    const API_BASE = '/api/niebocross';
  
    // Helper function to get error message with special handling for INVALID_CODE
    function getErrorMessage(errorCode) {
      // Special handling for INVALID_CODE to include clickable link
      if (errorCode === 'INVALID_CODE') {
        return `${errorMessages.INVALID_CODE}. ${errorMessages.INVALID_CODE_CONTACT}, <a href="/niebocross#kontakt" class="font-semibold text-emerald-600 hover:underline">${errorMessages.INVALID_CODE_CONTACT_LINK}</a>.`;
      }
      return errorMessages[errorCode] || errorMessages.generic;
    }

    // State
    let currentEmail = '';
    let sessionToken = '';
    let isAddingToExistingRegistration = false;
    let skipPaymentStep = false;

    // DOM Elements
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const step3 = document.getElementById('step3');
    const step4 = document.getElementById('step4');
    const emailForm = document.getElementById('emailForm');
    const codeForm = document.getElementById('codeForm');
    const participantsForm = document.getElementById('participantsForm');
    const emailError = document.getElementById('emailError');
    const codeError = document.getElementById('codeError');
    const codeSuccess = document.getElementById('codeSuccess');
    const participantsError = document.getElementById('participantsError');
    const backToEmailBtn = document.getElementById('backToEmail');
    const resendCodeBtn = document.getElementById('resendCodeBtn');
    const addParticipantBtn = document.getElementById('addParticipantBtn');
    const participantsContainer = document.getElementById('participantsContainer');
    const paymentLink = document.getElementById('paymentLink');
    const emailSubmitBtn = document.getElementById('emailSubmitBtn');
    const emailInput = document.getElementById('email');
    const fullNameInput = document.getElementById('fullName');
    const rodoCheckbox = document.getElementById('rodoAccepted');
    const termsCheckbox = document.getElementById('termsAccepted');
    const codeInput = document.getElementById('code');
    const codeSubmitBtn = document.getElementById('codeSubmitBtn');

    const finishAddingBtn = document.getElementById('finishAddingBtn');

    console.log('Elements found:', {
      emailSubmitBtn: !!emailSubmitBtn,
      emailInput: !!emailInput,
      fullNameInput: !!fullNameInput,
      rodoCheckbox: !!rodoCheckbox,
      termsCheckbox: !!termsCheckbox
    });

    let participantCount = 0;

    // Category to group mapping for limit checking
    const CATEGORY_TO_GROUP = {
      '3km_run': 'adults_runners',
      '9km_run': 'adults_runners',
      '3km_nw': 'nw',
      '9km_nw': 'nw',
      'kids_run': 'kids'
    };

    // Store current limits and counts
    let currentLimitsAndCounts = null;

    // Function to fetch current participant limits and counts
    async function fetchLimitsAndCounts() {
      try {
        const response = await fetch(`${API_BASE}/registrations/list`);
        const data = await response.json();
        if (data.success) {
          currentLimitsAndCounts = data.limitsAndCounts;
          console.log('Fetched limits and counts:', currentLimitsAndCounts);
          return true;
        }
      } catch (error) {
        console.error('Error fetching limits and counts:', error);
      }
      return false;
    }

    // Function to get disabled categories based on current counts
    function getDisabledCategories() {
      if (!currentLimitsAndCounts) return [];

      const disabled = [];
      for (const [category, group] of Object.entries(CATEGORY_TO_GROUP)) {
        const groupData = currentLimitsAndCounts[group];
        if (groupData && groupData.count >= groupData.limit) {
          disabled.push(category);
        }
      }
      return disabled;
    }

    // Function to update category options (disable/enable based on limits)
    async function updateCategoryOptions() {
      // First fetch the latest limits and counts
      await fetchLimitsAndCounts();
      
      const disabledCategories = getDisabledCategories();
      console.log('Disabled categories:', disabledCategories);

      // Update all existing participant forms
      const participantDivs = participantsContainer.querySelectorAll('[data-index]');
      participantDivs.forEach(div => {
        const index = div.getAttribute('data-index');
        const categoryInputs = div.querySelectorAll(`input[name="raceCategory_${index}"]`);

        categoryInputs.forEach(input => {
          const category = input.value;
          const isDisabled = disabledCategories.includes(category);
          input.disabled = isDisabled;

          // Update visual styling
          const label = input.closest('label');
          if (label) {
            if (isDisabled) {
              label.classList.add('opacity-50', 'cursor-not-allowed');
              label.classList.remove('cursor-pointer', 'hover:bg-emerald-50');
              label.title = 'Kategoria jest już pełna';
            } else {
              label.classList.remove('opacity-50', 'cursor-not-allowed');
              label.classList.add('cursor-pointer', 'hover:bg-emerald-50');
              label.title = '';
            }
          }
        });
      });
    }

    // Function to validate all participants
    function validateParticipants() {
      const participantDivs = participantsContainer.querySelectorAll('[data-index]');
      let allValid = true;

      participantDivs.forEach(div => {
        const index = div.getAttribute('data-index');
        const fullName = document.querySelector(`[name="fullName_${index}"]`).value.trim();
        const birthDay = document.querySelector(`[name="birthDay_${index}"]`).value;
        const birthMonth = document.querySelector(`[name="birthMonth_${index}"]`).value;
        const birthYear = document.querySelector(`[name="birthYear_${index}"]`).value;
        const city = document.querySelector(`[name="city_${index}"]`).value.trim();
        const nationality = document.querySelector(`[name="nationality_${index}"]`).value.trim();
        const phoneNumber = document.querySelector(`[name="phoneNumber_${index}"]`).value.trim();
        const raceCategory = document.querySelector(`input[name="raceCategory_${index}"]:checked`);

        if (!fullName || !birthDay || !birthMonth || !birthYear || !city || !nationality || !phoneNumber || !raceCategory) {
          allValid = false;
        }
      });

      // Disable buttons if no participants or any invalid
      const hasParticipants = participantDivs.length > 0;
      participantsSubmitBtn.disabled = !hasParticipants || !allValid;
      finishAddingBtn.disabled = !hasParticipants || !allValid;
    }

    // Check if already logged in
    const cookies = document.cookie.split(';').map(c => c.trim());
    const authStatusCookie = cookies.find(c => c.startsWith('niebocross_auth_status='));
    if (authStatusCookie && authStatusCookie.split('=')[1] === 'true') {
      // User is authenticated - check if they want to add participant
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('action') === 'add-participant') {
        // Skip to step 3 to add participants
        isAddingToExistingRegistration = true;
        step1.classList.add('hidden');
        step3.classList.remove('hidden');
        addParticipant(); // Add first participant form
      }
      // If authenticated but no specific action, allow normal registration flow
    }

    // Initial validation
    validateParticipants();


    // Validate email form and enable/disable submit button
    function validateEmailForm() {
      const emailValid = emailInput.value.trim() !== '';
      const nameValid = fullNameInput.value.trim() !== '';
      const rodoValid = rodoCheckbox.checked;
      const termsValid = termsCheckbox.checked;
      
      console.log('Validation check:', { emailValid, nameValid, rodoValid, termsValid });
      
      const isValid = emailValid && nameValid && rodoValid && termsValid;
      emailSubmitBtn.disabled = !isValid;
      console.log('Button disabled:', !isValid);
    }

    // Add event listeners to form fields
    emailInput.addEventListener('input', validateEmailForm);
    fullNameInput.addEventListener('input', validateEmailForm);
    rodoCheckbox.addEventListener('change', validateEmailForm);
    termsCheckbox.addEventListener('change', validateEmailForm);

    // Run initial validation in case form is pre-filled
    validateEmailForm();

    // Validate code input and enable/disable verify button
    function validateCodeForm() {
      const code = codeInput.value.trim();
      const isValidCode = code && /^[0-9]{6}$/.test(code);
      codeSubmitBtn.disabled = !isValidCode;
    }

    // Add event listener to code input
    codeInput.addEventListener('input', validateCodeForm);

    // Step 1: Email submission
    emailForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      emailError.classList.add('hidden');
      
      const formData = new FormData(emailForm);
      const email = formData.get('email');
      const fullName = formData.get('fullName');
      const rodoAccepted = formData.get('rodoAccepted') === 'on';
      const termsAccepted = formData.get('termsAccepted') === 'on';
      const website = formData.get('website') || '';

      console.log('Form submitted:', { email, fullName, rodoAccepted, termsAccepted });

      currentEmail = email;

      try {
        console.log('Sending request to:', `${API_BASE}/auth/start-registration`);
        const response = await fetch(`${API_BASE}/auth/start-registration`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, fullName, rodoAccepted, termsAccepted, website }),
        });

        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);

        if (!response.ok) {
          console.log('Error from API:', data.error);
          emailError.textContent = errorMessages[data.error] || errorMessages.generic;
          emailError.classList.remove('hidden');
          return;
        }

        console.log('Success! Moving to step 2');
        // Move to step 2
        step1.classList.add('hidden');
        step2.classList.remove('hidden');
      } catch (error) {
        console.error('Fetch error:', error);
        emailError.textContent = errorMessages.connection;
        emailError.classList.remove('hidden');
      }
    });

    // Back to email
    backToEmailBtn.addEventListener('click', () => {
      step2.classList.add('hidden');
      step1.classList.remove('hidden');
      codeError.classList.add('hidden');
      codeSuccess.classList.add('hidden');
    });

    // Resend code
    resendCodeBtn.addEventListener('click', async () => {
      if (!currentEmail) return;
      
      resendCodeBtn.disabled = true;
      resendCodeBtn.textContent = uiMessages.resending;
      codeError.classList.add('hidden');
      codeSuccess.classList.add('hidden');

      try {
        const response = await fetch(`${API_BASE}/auth/request-code`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: currentEmail }),
        });

        const data = await response.json();

        if (!response.ok) {
          codeError.textContent = getErrorMessage(data.error);
          codeError.classList.remove('hidden');
        } else {
          codeSuccess.textContent = uiMessages.codeResent;
          codeSuccess.classList.remove('hidden');
        }
      } catch {
        codeError.textContent = errorMessages.connection;
        codeError.classList.remove('hidden');
      } finally {
        resendCodeBtn.disabled = false;
        resendCodeBtn.textContent = uiMessages.resendCode;
      }
    });

    // Step 2: Code verification
    codeForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      codeError.classList.add('hidden');

      const formData = new FormData(codeForm);
      const code = formData.get('code');

      try {
        const response = await fetch(`${API_BASE}/auth/verify-code`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email: currentEmail, code }),
        });

        const data = await response.json();

        if (!response.ok) {
          const errorMsg = getErrorMessage(data.error);
          // Use innerHTML for INVALID_CODE to render the link
          if (data.error === 'INVALID_CODE') {
            codeError.innerHTML = errorMsg;
          } else {
            codeError.textContent = errorMsg;
          }
          codeError.classList.remove('hidden');
          return;
        }

        sessionToken = data.token;

        // Move to step 3
        step2.classList.add('hidden');
        step3.classList.remove('hidden');
        addParticipant(); // Add first participant
      } catch {
        codeError.textContent = errorMessages.connection;
        codeError.classList.remove('hidden');
      }
    });

    // Add participant form
    function addParticipant() {
      participantCount++;
      const participantDiv = document.createElement('div');
      participantDiv.className = 'rounded-xl border border-slate-200 bg-white p-6 shadow-sm mb-4';
      participantDiv.dataset.index = String(participantCount);
      
      participantDiv.innerHTML = `
        <div class="mb-4 flex items-center justify-between">
          <h3 class="text-lg font-bold text-slate-900">${formLabels.participant} ${participantCount}</h3>
          ${participantCount > 1 ? `<button type="button" class="remove-participant text-sm text-red-600 hover:underline" data-index="${participantCount}">${formLabels.remove}</button>` : ''}
        </div>
        <div class="grid gap-4 sm:grid-cols-2">
          <div class="sm:col-span-2">
            <label class="block text-sm font-semibold text-slate-700">
              ${formLabels.fullName} <span class="text-red-600">*</span>
            </label>
            <input type="text" name="fullName_${participantCount}" required class="mt-1 block w-full rounded-lg border-emerald-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 px-3 py-2 border-2" />
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700">
              ${formLabels.birthDate} <span class="text-red-600">*</span>
            </label>
            <div class="mt-1 grid grid-cols-3 gap-2">
              <select name="birthDay_${participantCount}" required class="block w-full rounded-lg border-emerald-300 border-2 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 px-2 py-2 text-center">
                <option value="">${formLabels.day || 'Dzień'}</option>
                ${Array.from({length: 31}, (_, i) => `<option value="${String(i + 1).padStart(2, '0')}">${i + 1}</option>`).join('')}
              </select>
              <select name="birthMonth_${participantCount}" required class="block w-full rounded-lg border-emerald-300 border-2 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 px-2 py-2 text-center">
                <option value="">${formLabels.month || 'Miesiąc'}</option>
                ${[
                  {val: '01', label: formLabels.months?.jan || 'Sty'},
                  {val: '02', label: formLabels.months?.feb || 'Lut'},
                  {val: '03', label: formLabels.months?.mar || 'Mar'},
                  {val: '04', label: formLabels.months?.apr || 'Kwi'},
                  {val: '05', label: formLabels.months?.may || 'Maj'},
                  {val: '06', label: formLabels.months?.jun || 'Cze'},
                  {val: '07', label: formLabels.months?.jul || 'Lip'},
                  {val: '08', label: formLabels.months?.aug || 'Sie'},
                  {val: '09', label: formLabels.months?.sep || 'Wrz'},
                  {val: '10', label: formLabels.months?.oct || 'Paź'},
                  {val: '11', label: formLabels.months?.nov || 'Lis'},
                  {val: '12', label: formLabels.months?.dec || 'Gru'}
                ].map(m => `<option value="${m.val}">${m.label}</option>`).join('')}
              </select>
              <select name="birthYear_${participantCount}" required class="block w-full rounded-lg border-emerald-300 border-2 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 px-2 py-2 text-center">
                <option value="">${formLabels.year || 'Rok'}</option>
                ${Array.from({length: 100}, (_, i) => {
                  const year = new Date().getFullYear() - i;
                  return `<option value="${year}">${year}</option>`;
                }).join('')}
              </select>
            </div>
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700">
              ${formLabels.city} <span class="text-red-600">*</span>
            </label>
            <input type="text" name="city_${participantCount}" required class="mt-1 block w-full rounded-lg border-emerald-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 px-3 py-2 border-2" />
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700">
              ${formLabels.nationality} <span class="text-red-600">*</span>
            </label>
            <input type="text" name="nationality_${participantCount}" required value="Polska" class="mt-1 block w-full rounded-lg border-emerald-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 px-3 py-2 border-2" />
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700">
              ${formLabels.club}
            </label>
            <div class="relative">
              <input type="text" name="club_${participantCount}" class="club-input mt-1 block w-full rounded-lg border-emerald-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 px-3 py-2 border-2" data-participant-index="${participantCount}" autocomplete="off" />
              <div class="club-suggestions absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-48 overflow-y-auto"></div>
            </div>
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700">
              ${formLabels.phoneNumber} <span class="text-red-600">*</span>
            </label>
            <input type="text" name="phoneNumber_${participantCount}" required class="mt-1 block w-full rounded-lg border-emerald-300 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 px-3 py-2 border-2" placeholder="123456789" />
            <p class="mt-1 text-xs text-slate-600">${formLabels.phoneHelp}</p>
          </div>
          <div class="sm:col-span-2">
            <label class="block text-sm font-semibold text-slate-700 mb-3">
              ${formLabels.distanceActivity} <span class="text-red-600">*</span>
            </label>
            <div class="grid gap-3 sm:grid-cols-2">
              <label class="flex items-center gap-2 p-3 rounded-lg border-2 border-emerald-300 cursor-pointer hover:bg-emerald-50 transition">
                <input type="radio" name="raceCategory_${participantCount}" value="3km_run" required class="text-emerald-600 focus:ring-emerald-500" />
                <span class="text-sm font-medium">${formLabels.categories["3km_run"]}</span>
              </label>
              <label class="flex items-center gap-2 p-3 rounded-lg border-2 border-emerald-300 cursor-pointer hover:bg-emerald-50 transition">
                <input type="radio" name="raceCategory_${participantCount}" value="3km_nw" required class="text-emerald-600 focus:ring-emerald-500" />
                <span class="text-sm font-medium">${formLabels.categories["3km_nw"]}</span>
              </label>
              <label class="flex items-center gap-2 p-3 rounded-lg border-2 border-emerald-300 cursor-pointer hover:bg-emerald-50 transition">
                <input type="radio" name="raceCategory_${participantCount}" value="9km_run" required class="text-emerald-600 focus:ring-emerald-500" />
                <span class="text-sm font-medium">${formLabels.categories["9km_run"]}</span>
              </label>
              <label class="flex items-center gap-2 p-3 rounded-lg border-2 border-emerald-300 cursor-pointer hover:bg-emerald-50 transition">
                <input type="radio" name="raceCategory_${participantCount}" value="9km_nw" required class="text-emerald-600 focus:ring-emerald-500" />
                <span class="text-sm font-medium">${formLabels.categories["9km_nw"]}</span>
              </label>
              <label class="flex items-center gap-2 p-3 rounded-lg border-2 border-emerald-300 cursor-pointer hover:bg-emerald-50 transition">
                <input type="radio" name="raceCategory_${participantCount}" value="kids_run" required class="text-emerald-600 focus:ring-emerald-500" />
                <span class="text-sm font-medium">${formLabels.categories["kids_run"]}</span>
              </label>
            </div>
            <p class="mt-2 text-sm text-slate-600">ℹ️ ${formLabels.kidsRunInfo}</p>
          </div>
          <div>
            <label class="block text-sm font-semibold text-slate-700">
              ${formLabels.tshirtSize}
            </label>
            <p class="text-xs text-slate-500 mt-1">${formLabels.tshirtInfo}</p>
            <select name="tshirtSize_${participantCount}" class="mt-1 block w-full rounded-lg border-emerald-300 border-2 shadow-sm focus:border-emerald-500 focus:ring-emerald-500 tshirt-size">
              <option value="">${formLabels.noTshirt}</option>
              <option value="XS">XS</option>
              <option value="S">S</option>
              <option value="M">M</option>
              <option value="L">L</option>
              <option value="XL">XL</option>
              <option value="XXL">XXL</option>
            </select>
          </div>
          <div class="sm:col-span-2">
            <label class="flex items-start gap-2">
              <input type="checkbox" name="hideNamePublic_${participantCount}" class="mt-1 rounded border-emerald-300 border-2 text-emerald-600 focus:ring-emerald-500" />
              <span class="text-sm text-slate-700">${formLabels.hideNamePublic}</span>
            </label>
          </div>
        </div>
      `;

      participantsContainer.appendChild(participantDiv);
      updateSummary();

      // Add event listeners for validation
      const inputs = participantDiv.querySelectorAll('input[name], select[name]');
      inputs.forEach(input => {
        if (input.type === 'radio' || input.type === 'checkbox') {
          input.addEventListener('change', validateParticipants);
        } else {
          input.addEventListener('input', validateParticipants);
        }
      });

      // Validate after adding
      validateParticipants();

      // Add phone input validation
      const phoneInput = participantDiv.querySelector(`[name="phoneNumber_${participantCount}"]`);
      if (phoneInput) {
        phoneInput.addEventListener('input', () => {
          const digits = phoneInput.value.replace(/\D/g, '').slice(0, 9);
          phoneInput.value = digits;
        });
      }

      // Add event listeners for remove buttons
      const removeBtn = participantDiv.querySelector('.remove-participant');
      if (removeBtn) {
        removeBtn.addEventListener('click', () => {
          participantDiv.remove();
          participantCount--;
          renumberTitles();
          updateSummary();
          validateParticipants();
        });
      }

      // Add event listeners for category and tshirt changes
      participantDiv.querySelectorAll('input[type="radio"], .tshirt-size').forEach(el => {
        el.addEventListener('change', updateSummary);
      });

      // Initialize club autocomplete for the new input
      if (window.setupClubAutocomplete) {
        window.setupClubAutocomplete();
      }
    }

    // Renumber participant titles after removal
    function renumberTitles() {
      const participantDivs = participantsContainer.querySelectorAll('[data-index]');
      participantDivs.forEach((div, index) => {
        const title = div.querySelector('h3');
        if (title) {
          title.textContent = `${formLabels.participant} ${index + 1}`;
        }
      });
    }

    addParticipantBtn.addEventListener('click', addParticipant);
    
    // Add event listener for finish adding button (always enabled - user can pay later)
    finishAddingBtn.addEventListener('click', () => {
      skipPaymentStep = true;
      participantsForm.requestSubmit();
    });
    
    // Add event listener for extra donation
    document.getElementById('extraDonation').addEventListener('input', updateSummary);

    // Update payment summary
    function updateSummary() {
      let raceFees = 0;
      let tshirtFees = 0;

      document.querySelectorAll('[data-index]').forEach(div => {
        const index = div.getAttribute('data-index');
        const category = document.querySelector(`input[name="raceCategory_${index}"]:checked`)?.value;
        const tshirt = document.querySelector(`[name="tshirtSize_${index}"]`)?.value;

        if (category === 'kids_run') {
          raceFees += 20;
        } else if (category) {
          raceFees += 60;
        }

        if (tshirt) {
          tshirtFees += 80;
        }
      });

      const extraDonation = parseInt(document.getElementById('extraDonation')?.value || '0');
      const totalAmount = raceFees + tshirtFees + extraDonation;
      const charityAmount = raceFees + (tshirtFees * 10 / 80) + extraDonation;

      document.getElementById('raceFees').textContent = `${raceFees} zł`;
      document.getElementById('tshirtFees').textContent = `${tshirtFees} zł`;
      document.getElementById('totalAmount').textContent = `${totalAmount} zł`;
      document.getElementById('charityAmount').textContent = `${charityAmount.toFixed(2)} zł`;
    }

    // Step 3: Submit participants
    participantsForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      participantsError.classList.add('hidden');

      const participants = [];
      
      document.querySelectorAll('[data-index]').forEach(div => {
        const index = div.getAttribute('data-index');
        const birthDay = document.querySelector(`[name="birthDay_${index}"]`).value;
        const birthMonth = document.querySelector(`[name="birthMonth_${index}"]`).value;
        const birthYear = document.querySelector(`[name="birthYear_${index}"]`).value;
        participants.push({
          fullName: document.querySelector(`[name="fullName_${index}"]`).value,
          birthDate: `${birthYear}-${birthMonth}-${birthDay}`,
          city: document.querySelector(`[name="city_${index}"]`).value,
          nationality: document.querySelector(`[name="nationality_${index}"]`).value,
          club: document.querySelector(`[name="club_${index}"]`).value || null,
          phoneNumber: document.querySelector(`[name="phoneNumber_${index}"]`).value,
          raceCategory: document.querySelector(`input[name="raceCategory_${index}"]:checked`).value,
          tshirtSize: document.querySelector(`[name="tshirtSize_${index}"]`).value || null,
          hideNamePublic: document.querySelector(`[name="hideNamePublic_${index}"]`).checked,
        });
      });

      try {
        let response;

        if (isAddingToExistingRegistration) {
          // Adding participants to existing registration
          response = await fetch(`${API_BASE}/add-participants`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            credentials: 'include',
            body: JSON.stringify({ participants }),
          });
        } else {
          // New registration with multiple participants
          const extraDonation = parseInt(document.getElementById('extraDonation').value || '0');
          const headers = { 'Content-Type': 'application/json' };
          // Use Bearer token if available, otherwise rely on cookie auth
          if (sessionToken) {
            headers['Authorization'] = `Bearer ${sessionToken}`;
          }
          response = await fetch(`${API_BASE}/register`, {
            method: 'POST',
            headers,
            credentials: 'include',
            body: JSON.stringify({ participants, extraDonation }),
          });
        }

        const data = await response.json();

        if (!response.ok) {
          participantsError.textContent = data.error || errorMessages.generic;
          participantsError.classList.remove('hidden');
          return;
        }

        if (isAddingToExistingRegistration || skipPaymentStep) {
          // Redirect to panel (user can pay later)
          window.location.href = '/niebocross/panel';
        } else {
          // Move to step 4
          paymentLink.href = `/niebocross/payment?id=${data.registrationId}`;
          step3.classList.add('hidden');
          step4.classList.remove('hidden');
        }
      } catch {
        participantsError.textContent = errorMessages.connection;
        participantsError.classList.remove('hidden');
      }
    });

    // Initialize club autocomplete and category limits
    updateCategoryOptions();

    // Re-initialize autocomplete when adding new participants
    document.getElementById('addParticipantBtn').addEventListener('click', () => {
      setTimeout(() => {
        setupClubAutocomplete();
        updateCategoryOptions();
      }, 100);
    });
  </script>
