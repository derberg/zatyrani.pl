---
import ParticipantFieldset from "./ParticipantFieldset.astro";
import RegistrationSummary from "./RegistrationSummary.astro";
import ClubAutocomplete from "./ClubAutocomplete.astro";

interface Props {
  t: (key: string) => string;
  locale?: string;
}

const { t, locale = 'pl' } = Astro.props;
---

<div class="mx-auto max-w-4xl px-6 py-12">
  <!-- Auth check message -->
  <div id="authCheck" class="text-center py-12">
    <p class="text-lg text-slate-600">{t("niebocross.add_participants.checking_auth")}</p>
  </div>

  <!-- Main content (hidden until auth verified) -->
  <div id="content" class="hidden space-y-6">
    <div class="text-center">
      <h2 class="text-3xl font-bold text-slate-900">{t("niebocross.add_participants.title")}</h2>
      <p class="mt-2 text-slate-600">{t("niebocross.add_participants.description")}</p>
    </div>

    <div class="grid gap-6 lg:grid-cols-[1fr_300px]">
      <div class="space-y-6">
        <form id="addParticipantsForm" class="space-y-6">
          <div id="participantsContainer">
            <!-- First participant rendered server-side -->
            <ParticipantFieldset index={1} t={t} showRemoveButton={false} />
          </div>

          <button
            type="button"
            id="addParticipantBtn"
            class="rounded-lg border-2 border-dashed border-emerald-300 bg-emerald-50 px-6 py-3 font-semibold text-emerald-700 transition hover:border-emerald-400 hover:bg-emerald-100"
          >
            + {t("niebocross.form.add_participant")}
          </button>

          <div id="error" class="hidden rounded-lg bg-red-50 p-3 text-sm text-red-700"></div>

          <button
            type="submit"
            id="submitBtn"
            class="w-full rounded-lg bg-emerald-600 px-6 py-3 font-semibold text-white transition hover:bg-emerald-700 disabled:bg-slate-300 disabled:cursor-not-allowed"
            disabled
          >
            {t("niebocross.add_participants.submit")}
          </button>

          <a
            href={locale === 'en' ? '/en/niebocross/panel' : '/niebocross/panel'}
            class="block w-full rounded-lg bg-white border-2 border-emerald-300 px-6 py-3 text-center font-semibold text-slate-700 transition hover:bg-slate-50"
          >
            ← {t("niebocross.add_participants.back_to_panel")}
          </a>
        </form>
      </div>

      <div class="lg:sticky lg:top-6 lg:self-start">
        <RegistrationSummary t={t} />
      </div>
    </div>
  </div>
</div>

<ClubAutocomplete />

<script define:vars={{
  locale,
  errorMessages: {
    connection: t("niebocross.errors.connection_error"),
    generic: t("niebocross.errors.generic_error")
  },
  formLabels: {
    participant: t("niebocross.form.participant"),
    remove: t("niebocross.form.remove")
  }
}}>
  // API Base URL
  const API_BASE = '/api/niebocross';

  // Check authentication
  const cookies = document.cookie.split(';').map(c => c.trim());
  const authCookie = cookies.find(c => c.startsWith('niebocross_auth_status='));

  if (!authCookie || authCookie.split('=')[1] !== 'true') {
    window.location.href = locale === 'en' ? '/en/niebocross/zaloguj' : '/niebocross/zaloguj';
  } else {
    // Show content
    document.getElementById('authCheck').classList.add('hidden');
    document.getElementById('content').classList.remove('hidden');
  }

  // State
  let participantCount = 1;

  // Category to group mapping for limit checking
  const CATEGORY_TO_GROUP = {
    '3km_run': 'adults_runners',
    '9km_run': 'adults_runners',
    '3km_nw': 'nw',
    '9km_nw': 'nw',
    'kids_run': 'kids'
  };

  // Store current limits and counts
  let currentLimitsAndCounts = null;

  // Function to fetch current participant limits and counts
  async function fetchLimitsAndCounts() {
    try {
      const response = await fetch(`${API_BASE}/registrations/list`);
      const data = await response.json();
      if (data.success) {
        currentLimitsAndCounts = data.limitsAndCounts;
        return true;
      }
    } catch (error) {
      console.error('Error fetching limits and counts:', error);
    }
    return false;
  }

  // Function to get disabled categories based on current counts
  function getDisabledCategories() {
    if (!currentLimitsAndCounts) return [];

    const disabled = [];
    for (const [category, group] of Object.entries(CATEGORY_TO_GROUP)) {
      const groupData = currentLimitsAndCounts[group];
      if (groupData && groupData.count >= groupData.limit) {
        disabled.push(category);
      }
    }
    return disabled;
  }

  // Function to update category options (disable/enable based on limits)
  async function updateCategoryOptions() {
    await fetchLimitsAndCounts();
    const disabledCategories = getDisabledCategories();

    const participantDivs = document.querySelectorAll('[data-index]');
    participantDivs.forEach(div => {
      const index = div.getAttribute('data-index');
      const categoryInputs = div.querySelectorAll(`input[name="raceCategory_${index}"]`);

      categoryInputs.forEach(input => {
        const category = input.value;
        const isDisabled = disabledCategories.includes(category);
        input.disabled = isDisabled;

        const label = input.closest('label');
        if (label) {
          if (isDisabled) {
            label.classList.add('opacity-50', 'cursor-not-allowed');
            label.classList.remove('cursor-pointer', 'hover:bg-emerald-50');
            label.title = 'Category is full';
          } else {
            label.classList.remove('opacity-50', 'cursor-not-allowed');
            label.classList.add('cursor-pointer', 'hover:bg-emerald-50');
            label.title = '';
          }
        }
      });
    });
  }

  // Helper functions
  function updateFieldNames(element, newIndex) {
    element.setAttribute('data-index', newIndex);

    element.querySelectorAll('[name]').forEach(input => {
      const name = input.getAttribute('name');
      input.setAttribute('name', name.replace(/_\d+$/, `_${newIndex}`));
    });

    const title = element.querySelector('h3');
    if (title) {
      title.textContent = `${formLabels.participant} ${newIndex}`;
    }

    const removeBtn = element.querySelector('.remove-participant');
    if (removeBtn) {
      removeBtn.setAttribute('data-index', newIndex);
    }
  }

  function clearFieldValues(element) {
    element.querySelectorAll('input[type="text"], input[type="email"]').forEach(input => {
      if (!input.classList.contains('club-input')) {
        input.value = '';
      }
    });

    element.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(input => {
      input.checked = false;
    });

    element.querySelectorAll('select').forEach(select => {
      select.selectedIndex = 0;
    });

    // Reset nationality to default
    const nationality = element.querySelector('[name*="nationality_"]');
    if (nationality) {
      nationality.value = 'Polska';
    }
  }

  function addRemoveButton(element, index) {
    const header = element.querySelector('.mb-4');
    if (!header.querySelector('.remove-participant')) {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'remove-participant text-sm text-red-600 hover:underline';
      btn.textContent = formLabels.remove;
      btn.setAttribute('data-index', index);
      btn.addEventListener('click', () => removeParticipant(index));
      header.appendChild(btn);
    }
  }

  // Add participant
  function addParticipant() {
    participantCount++;

    // Clone the first participant
    const first = document.querySelector('[data-index="1"]');
    const clone = first.cloneNode(true);

    // Update index and field names
    updateFieldNames(clone, participantCount);
    clearFieldValues(clone);
    addRemoveButton(clone, participantCount);

    // Append
    document.getElementById('participantsContainer').appendChild(clone);

    // Re-initialize
    if (window.setupClubAutocomplete) {
      window.setupClubAutocomplete();
    }
    if (window.setupPhoneValidation) {
      window.setupPhoneValidation();
    }

    // Setup validation listeners for the new participant
    setupValidationListeners(clone);

    updateCategoryOptions();
    updateSummary();
    validateParticipants();
  }

  // Remove participant
  function removeParticipant(index) {
    const element = document.querySelector(`[data-index="${index}"]`);
    if (element) {
      element.remove();
      participantCount--;
      renumberParticipants();
      updateSummary();
      validateParticipants();
    }
  }

  // Renumber participants after removal
  function renumberParticipants() {
    const participantDivs = Array.from(document.querySelectorAll('[data-index]'));
    participantDivs.forEach((div, index) => {
      const newIndex = index + 1;
      const title = div.querySelector('h3');
      if (title) {
        title.textContent = `${formLabels.participant} ${newIndex}`;
      }
    });
  }

  // Setup validation listeners for participant fields
  function setupValidationListeners(participantDiv) {
    const inputs = participantDiv.querySelectorAll('input[name], select[name]');
    inputs.forEach(input => {
      // Remove existing listeners by cloning and replacing (prevents duplicates)
      const newInput = input.cloneNode(true);
      input.parentNode.replaceChild(newInput, input);

      if (newInput.type === 'radio' || newInput.type === 'checkbox') {
        newInput.addEventListener('change', () => {
          validateParticipants();
          updateSummary();
        });
      } else {
        newInput.addEventListener('input', () => {
          validateParticipants();
          updateSummary();
        });
      }
    });
  }

  // Collect participant data
  function collectParticipantData() {
    const participants = [];
    document.querySelectorAll('[data-index]').forEach(div => {
      const index = div.getAttribute('data-index');

      participants.push({
        fullName: document.querySelector(`[name="fullName_${index}"]`).value,
        birthDate: document.querySelector(`[name="birthDate_${index}"]`).value,
        city: document.querySelector(`[name="city_${index}"]`).value,
        nationality: document.querySelector(`[name="nationality_${index}"]`).value,
        club: document.querySelector(`[name="club_${index}"]`).value || null,
        phoneNumber: document.querySelector(`[name="phoneNumber_${index}"]`).value,
        raceCategory: document.querySelector(`input[name="raceCategory_${index}"]:checked`).value,
        tshirtSize: document.querySelector(`[name="tshirtSize_${index}"]`).value,
        hideNamePublic: document.querySelector(`[name="hideNamePublic_${index}"]`).checked,
      });
    });

    return participants;
  }

  // Validate participants
  function validateParticipants() {
    const participantDivs = document.querySelectorAll('[data-index]');
    let allValid = true;

    participantDivs.forEach(div => {
      const index = div.getAttribute('data-index');
      const fullName = document.querySelector(`[name="fullName_${index}"]`)?.value.trim();
      const birthDate = document.querySelector(`[name="birthDate_${index}"]`)?.value;
      const city = document.querySelector(`[name="city_${index}"]`)?.value.trim();
      const nationality = document.querySelector(`[name="nationality_${index}"]`)?.value.trim();
      const phoneNumber = document.querySelector(`[name="phoneNumber_${index}"]`)?.value.trim();
      const raceCategory = document.querySelector(`input[name="raceCategory_${index}"]:checked`);
      const tshirtSize = document.querySelector(`[name="tshirtSize_${index}"]`)?.value;

      if (!fullName || !birthDate || !city || !nationality || !phoneNumber || !raceCategory || !tshirtSize) {
        allValid = false;
      }
    });

    const hasParticipants = participantDivs.length > 0;
    document.getElementById('submitBtn').disabled = !hasParticipants || !allValid;
  }

  // Update summary
  function updateSummary() {
    let raceFees = 0;

    document.querySelectorAll('[data-index]').forEach(div => {
      const index = div.getAttribute('data-index');
      const category = document.querySelector(`input[name="raceCategory_${index}"]:checked`)?.value;

      if (category === 'kids_run') {
        raceFees += 20;
      } else if (category) {
        raceFees += 60;
      }
    });

    const extraDonation = parseInt(document.getElementById('extraDonation')?.value || '0');
    const totalAmount = raceFees + extraDonation;
    const charityAmount = raceFees + extraDonation;

    document.getElementById('raceFees').textContent = `${raceFees} zł`;
    document.getElementById('totalAmount').textContent = `${totalAmount} zł`;
    document.getElementById('charityAmount').textContent = `${charityAmount.toFixed(2)} zł`;
  }

  // Form submission
  document.getElementById('addParticipantsForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const errorDiv = document.getElementById('error');
    errorDiv.classList.add('hidden');

    try {
      const participants = collectParticipantData();

      const response = await fetch(`${API_BASE}/add-participants`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ participants })
      });

      const data = await response.json();

      if (!response.ok) {
        errorDiv.textContent = data.error || errorMessages.generic;
        errorDiv.classList.remove('hidden');
        return;
      }

      // Redirect to panel
      window.location.href = locale === 'en' ? '/en/niebocross/panel' : '/niebocross/panel';
    } catch (error) {
      console.error('Error:', error);
      errorDiv.textContent = errorMessages.connection;
      errorDiv.classList.remove('hidden');
    }
  });

  // Event listeners
  document.getElementById('addParticipantBtn').addEventListener('click', addParticipant);
  document.getElementById('extraDonation')?.addEventListener('input', updateSummary);

  // Add validation listeners to all existing participant fields
  document.querySelectorAll('[data-index]').forEach(div => {
    setupValidationListeners(div);
  });

  // Initialize
  updateCategoryOptions();
  updateSummary();
  validateParticipants();
</script>
