---
import type { Events } from "../data/events";

interface Props {
  event?: Events;
}

const { event } = Astro.props;

const submitButtonText = event ? "Zapisz zmiany" : "Dodaj wydarzenie";

const formatDateForInput = (dateString) => {
  if (!dateString) return "";
  const [day, month, year] = dateString.split("/");
  return `${year}-${month}-${day}`;
};
---

<form id="eventForm" class="max-w-2xl mx-auto p-4">
  <div class="space-y-4">
    {event && <input type="hidden" name="uid" value={event.uid} />}
    <div>
      <label class="block text-sm font-medium text-gray-700">
        <strong>Nazwa wydarzenia</strong>
        <span class="text-red-600">*</span>
      </label>
      <p class="text-xs text-gray-600">Krótka nazwa, np. Wilczy Półmaraton</p>
      <input
        type="text"
        name="name"
        required
        class="mt-1 block w-full rounded-md border-purple-300 shadow-sm border-2 focus:border-purple-500 focus:ring-purple-500"
        value={event?.title}
      />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700">
        <strong>Data startu</strong>
        <span class="text-red-600">*</span>
      </label>
      <p class="text-xs text-gray-600">
        Zawsze jest na wydarzeniu na fejsie, a jak nie ma wydarzenia na fejsie to na bank konkretne
        informacje znajdują się w regulaminie który zawsze jest dostępny na stronie rejestracji.
      </p>
      <input
        type="date"
        name="date"
        required
        class="mt-1 block w-full rounded-md border-purple-300 shadow-sm border-2 focus:border-purple-500 focus:ring-purple-500"
        value={event?.date ? formatDateForInput(event.date) : ""}
      />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700">
        <strong>Miejscowość</strong>
        <span class="text-red-600">*</span>
      </label>
      <p class="text-xs text-gray-600">Tam gdzie jest start</p>
      <input
        type="text"
        name="location"
        required
        class="mt-1 block w-full rounded-md border-purple-300 shadow-sm border-2 focus:border-purple-500 focus:ring-purple-500"
        value={event?.location}
      />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700">
        <strong>Opis</strong>
        <span class="text-red-600">*</span>
      </label>
      <p class="text-xs text-gray-600">
        Nie jakiś nie wiadomo jaki elaborat, tylko krótkie info czy to tylko bieganie, czy może też
        kije, a najlepiej żeby też zaznaczyć czy jest start dla dzieci. Można zaznaczyć też mniej
        więcej jaki dystans. Może być np. "Bieg na różnych dystansach. Dzieciaki też mogą biec."
        albo "Bieg na 20km i 5km z kijami."
      </p>
      <input
        type="text"
        name="description"
        id="descriptionn"
        maxlength="150"
        required
        class="mt-1 block w-full rounded-md border-purple-300 shadow-sm border-2 focus:border-purple-500 focus:ring-purple-500"
        value={event?.description}
      />
      <p id="charCount" class="text-purple-500 text-xs">0 / 150</p>
      <p id="warning" class="text-red-500 text-xs" style="display: none;">
        ⚠️ Maksymalny limit znaków osiągnięty.
      </p>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700">
        <strong>Link do głównej strony wydarzenia</strong>
        <span class="text-red-600">*</span>
      </label>
      <p class="text-xs text-gray-600">
        Sam link, nic więcej, bez dodatkowego tekstu, może być link do wydarzenia na fejsie.
      </p>
      <input
        type="url"
        name="website"
        required
        class="mt-1 block w-full rounded-md border-purple-300 shadow-sm border-2 focus:border-purple-500 focus:ring-purple-500"
        value={event?.mainLink}
      />
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700">
        <strong>Link do strony rejestracji</strong>
      </label>
      <p class="text-xs text-gray-600">
        Sam link, nic więcej, bez dodatkowego tekstu. Dodaj, ułatw innym rejestrację. Oczywiście
        może się zdarzyć, że dodajesz wydarzenie tak wcześnie, że strona rejestracji jeszcze nie
        jest dostępna. Wtedy zostaw to pole puste i się nie martw.
      </p>
      <input
        type="url"
        name="registration"
        class="mt-1 block w-full rounded-md border-purple-300 shadow-sm border-2 focus:border-purple-500 focus:ring-purple-500"
        value={event?.registrationLink}
      />
    </div>
    <div class="text-center">
      <button
        type="submit"
        class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:shadow-outline"
      >
        {submitButtonText}
      </button>

      <a
        href="/wydarzenia"
        class="ml-4 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:shadow-outline inline-block"
      >
        Wróć
      </a>
    </div>
  </div>
</form>
<script define:vars={{ initialEvent: event }}>
  window.addEventListener("DOMContentLoaded", () => {
    const textarea = document.getElementById("descriptionn");
    const charCount = document.getElementById("charCount");
    const warning = document.getElementById("warning");

    // Initialize char count for pre-filled description
    if (textarea) {
      const length = textarea.value.length;
      charCount.textContent = `${length} / 150`;
      if (length > 149) {
        warning.style.display = "block";
      }
    }

    textarea.addEventListener("input", () => {
      const length = textarea.value.length;
      charCount.textContent = `${length} / 150`;

      if (length > 149) {
        warning.style.display = "block";
      } else {
        warning.style.display = "none";
      }
    });
  });
  const form = document.getElementById("eventForm");
  const submitButton = form.querySelector('button[type="submit"]'); // Get the submit button

  form.addEventListener("submit", async (e) => {
    e.preventDefault();

    // Disable the submit button to prevent multiple clicks
    submitButton.disabled = true;
    submitButton.classList.add("opacity-50", "cursor-not-allowed");

    // Check for validity of required fields
    const formElements = e.target.elements;
    let valid = true;

    for (const element of formElements) {
      if (element.required && !element.value) {
        valid = false;
        element.classList.add("border-red-600");
        element.classList.add("focus:ring-red-500");
      } else {
        element.classList.remove("border-red-600");
        element.classList.remove("focus:ring-red-500");
      }
    }

    if (!valid) {
      alert("Wszystkie pola oznaczone gwiazdką (*) są wymagane.");
      // Re-enable the submit button on invalid form
      submitButton.disabled = false;
      submitButton.classList.remove("opacity-50", "cursor-not-allowed");
      return;
    }

    const formData = new FormData(e.target);
    const eventData = Object.fromEntries(formData);

    const isUpdate = initialEvent && initialEvent.uid;
    const apiUrl = isUpdate ? "/api/update-event" : "/api/add-event";
    const apiMethod = isUpdate ? "PUT" : "POST";
    const successMessage = isUpdate
      ? "Wydarzenie zaktualizowane pomyślnie!"
      : "Wydarzenie dodane pomyślnie!";
    const errorMessage = isUpdate
      ? "Błąd podczas aktualizacji wydarzenia. Daj znała Łukaszowi bo pewnie on coś zdupił."
      : "Błąd podczas dodawania wydarzenia. Daj znała Łukaszowi bo pewnie on coś zdupił.";

    try {
      const response = await fetch(apiUrl, {
        method: apiMethod,
        body: JSON.stringify(eventData),
        headers: {
          "Content-Type": "application/json",
        },
      });

      if (response.ok) {
        alert(successMessage);
        if (!isUpdate) {
          form.reset();
        } else {
          window.location.href = "/wydarzenia"; // Redirect to events list after update
        }
      } else {
        throw new Error(errorMessage);
      }
    } catch (error) {
      alert("Wystąpił błąd: " + error.message);
    } finally {
      // Re-enable the submit button once the process is complete
      submitButton.disabled = false;
      submitButton.classList.remove("opacity-50", "cursor-not-allowed");
    }
  });
</script>
