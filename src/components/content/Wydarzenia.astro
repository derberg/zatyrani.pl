---
import PageHeader from "../PageHeader.astro";
import EventCard from "../EventCard.astro";
import { events } from "../../data/events";

interface Props {
  t: (key: string) => string;
}

const { t } = Astro.props;

const currentDate = new Date(); // Get the current date

// Function to parse a DD/MM/YYYY string into a Date object
function parseDate(dateString: string): Date {
  const [day, month, year] = dateString.split("/");
  return new Date(+year, +month - 1, +day); // Use "+" to convert to numbers
}

// Filter and sort events: Show only future events, sorted from closest to the current date (ascending)
const futureEvents = events
  .filter((event) => parseDate(event.date) > currentDate) // Filter future events
  .sort((a, b) => {
    const dateA = parseDate(a.date);
    const dateB = parseDate(b.date);
    return dateA.getTime() - dateB.getTime(); // Compare timestamps
  });

// Image assignment logic with caching
const imageFiles = import.meta.glob("/public/events/ai/*", { eager: true });
const fallbackImages = Object.keys(imageFiles).map((path) => "/" + path.replace("/public/", ""));
const usedImagesCache = new Set<string>();

function getNextFallbackImage(): string {
  // If all images have been used, reset the cache
  if (usedImagesCache.size === fallbackImages.length) {
    usedImagesCache.clear();
  }

  // Find unused images
  const unusedImages = fallbackImages.filter(img => !usedImagesCache.has(img));
  
  // Use unused images if available, otherwise fall back to all images
  const availableImages = unusedImages.length > 0 ? unusedImages : fallbackImages;
  
  // Randomly select from available images
  const selectedImage = availableImages[Math.floor(Math.random() * availableImages.length)];
  
  // Mark as used
  usedImagesCache.add(selectedImage);
  
  return selectedImage;
}

// Assign images to events with caching
const eventsWithAssignedImages = futureEvents.map(event => ({
  ...event,
  assignedFallbackImage: event.image ? event.image : getNextFallbackImage()
}));
---

<PageHeader
  title={t("events.page_title")}
  subtitle={t("events.page_subtitle")}
  showAddEventButton={true}
/>

<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
  <div class="grid md:grid-cols-3 gap-8">
    {eventsWithAssignedImages.map((event) => <EventCard {...event} assignedFallbackImage={event.assignedFallbackImage} t={t} />)}
  </div>
</div>

<script>
  // Hide add event button if not logged in
  function getAuthState() {
    try {
      const raw = window.localStorage.getItem('authState');
      if (!raw) return { loggedIn: false };
      const parsed = JSON.parse(raw);
      if (!parsed || typeof parsed !== 'object') return { loggedIn: false };
      if (parsed.expiresAt && Date.now() > parsed.expiresAt) {
        window.localStorage.removeItem('authState');
        return { loggedIn: false };
      }
      return { loggedIn: !!parsed.loggedIn, expiresAt: parsed.expiresAt };
    } catch {
      return { loggedIn: false };
    }
  }

  const { loggedIn } = getAuthState();
  if (loggedIn) {
    const addButton = document.getElementById('add-event-button');
    if (addButton) addButton.style.display = 'inline-block';
  }
</script>