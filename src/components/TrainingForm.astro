---
import type { Training } from "../data/trainings";

const locations = [
  { name: "Nieborowice – PPK", link: "https://maps.app.goo.gl/cUnjGVWuHfnJDQTL8" },
  { name: "Nieborowice – Krzyż", link: "https://maps.app.goo.gl/4t3qjRxQpny7Ln6KA" },
  { name: "Wilcza – Cmentarz", link: "https://maps.app.goo.gl/NwiX62pvY3kmyV3M8" },
  { name: "Ochojec – Azyl Zatyranych", link: "https://maps.app.goo.gl/VdEFVwTmG6TRd4M96" },
  { name: "Stanica – Stacja", link: "https://maps.app.goo.gl/LGKq1drxyXzfK9bi7" },
  { name: "Leboszowice – Szwedownik", link: "https://maps.app.goo.gl/UA4atBHW9mkCv9A1A" },
  { name: "Pilchowice – Damrota", link: "https://maps.app.goo.gl/XnmUCsTWhwotmXr98" },
  { name: "Pilchowice – Wielopole", link: "https://maps.app.goo.gl/fTGv37UHmFpk3zL57" },
];

interface Props {
  training?: Training;
}

const { training } = Astro.props;

const submitButtonText = training ? "Zapisz zmiany" : "Dodaj trening";

const formatDateTimeForInput = (dateTimeString) => {
  if (!dateTimeString) return "";
  const [datePart, timePart] = dateTimeString.split(" ");
  const [day, month, year] = datePart.split("/");
  const [hours, minutes] = timePart.split(":");
  return `${year}-${month}-${day}T${hours}:${minutes}`;
};
---

<form id="trainingForm" autocomplete="off" class="max-w-2xl mx-auto p-4" method="POST">
  <div class="space-y-4">
    {training && <input type="hidden" name="uid" value={training.uid} />}
    
    <!-- Rodzaj treningu -->
    <div>
      <label class="block text-sm font-medium text-gray-700">
        <strong>Rodzaj treningu</strong>
        <span class="text-red-600">*</span>
      </label>
      <div class="mt-1 flex space-x-4">
        <label class="inline-flex items-center">
          <input
            type="radio"
            name="type"
            value="bieg"
            checked={training?.type === 'bieg'}
            required
            class="form-radio text-purple-600"
          />
          <span class="ml-2 text-sm text-gray-500">Bieg</span>
        </label>
        <label class="inline-flex items-center">
          <input
            type="radio"
            name="type"
            value="nordic walking"
            required
            checked={training?.type === 'nordic walking'}
            class="form-radio text-purple-600"
          />
          <span class="ml-2 text-sm text-gray-500">Nordic Walking</span>
        </label>
      </div>
    </div>

    <!-- Data i czas -->
    <div>
      <label for="datetime" class="block text-sm font-medium text-gray-700">
        <strong>Data i czas</strong>
        <span class="text-red-600">*</span>
      </label>
      <input
        type="datetime-local"
        id="datetime"
        name="datetime"
        required
        class="mt-1 block w-full rounded-md border-purple-300 border-2 shadow-sm focus:border-purple-500 focus:ring-purple-500 text-gray-500"
        value={training?.datetime ? formatDateTimeForInput(training.datetime) : ""}
      />
    </div>

    <!-- Lokalizacja -->
    <div>
      <label for="location" class="block text-sm font-medium text-gray-700">
        <strong>Lokalizacja</strong>
        <span class="text-red-600">*</span>
      </label>
      <select
        id="location"
        name="location"
        required
        class="mt-1 block w-full rounded-md border-purple-300 border-2 shadow-sm focus:border-purple-500 focus:ring-purple-500 text-gray-500"
      >
        <option value="" disabled selected={!training?.location} class="text-gray-500">Wybierz lokalizację</option>
        {
          locations.map((loc) => (
            <option 
              value={loc.name} 
              data-link={loc.link}
              selected={training?.location === loc.name}
            >
              {loc.name}
            </option>
          ))
        }
      </select>
      <input type="hidden" name="locationLink" id="locationLink" value={training?.locationLink} />
    </div>

    <!-- Komentarz -->
    <div>
      <label for="comment" class="block text-sm font-medium text-gray-700">
        <strong>Dodatkowy komentarz</strong>
      </label>
      <textarea
        id="comment"
        name="comment"
        rows="3"
        placeholder="Opcjonalny opis lub uwagi…"
        class="mt-1 block w-full rounded-md border-purple-300 border-2 shadow-sm focus:border-purple-500 focus:ring-purple-500 placeholder-gray-500 text-gray-500"
      >{training?.comment}</textarea>
    </div>

    <!-- Numer kontaktowy -->
    <div>
      <label for="phone" class="block text-sm font-medium text-gray-700">
        <strong>Numer kontaktowy prowadzącego</strong>
        <span class="text-red-600">*</span>
      </label>
      <input
        type="tel"
        id="phone"
        name="phone"
        autocomplete="off"
        required
        pattern="\\+?\\d{9,15}"
        placeholder="600 700 800"
        class="mt-1 block w-full rounded-md border-purple-300 border-2 shadow-sm focus:border-purple-500 focus:ring-purple-500 placeholder-gray-500 text-gray-500"
        value={training?.phone}
      />
    </div>

    <!-- Planowany dystans -->
    <div>
      <label for="distance" class="block text-sm font-medium text-gray-700">
        <strong>Planowany dystans (km)</strong>
        <span class="text-red-600">*</span>
      </label>
      <input
        type="number"
        id="distance"
        name="distance"
        min="1"
        max="50"
        autocomplete="off"
        required
        placeholder="np. 10"
        class="mt-1 block w-full rounded-md border-purple-300 border-2 shadow-sm focus:border-purple-500 focus:ring-purple-500 placeholder-gray-500 text-gray-500"
        value={training?.distance}
      />
    </div>

    <!-- Planowane tempo -->
    <div>
      <label for="pace" class="block text-sm font-medium text-gray-700">
        <strong>Planowane tempo (min/km)</strong>
        <span class="text-red-600">*</span>
      </label>
      <input
        type="number"
        id="pace"
        name="pace"
        min="3"
        max="12"
        step="1"
        autocomplete="off"
        required
        placeholder="np. 5"
        class="mt-1 block w-full rounded-md border-purple-300 border-2 shadow-sm focus:border-purple-500 focus:ring-purple-500 placeholder-gray-500 text-gray-500"
        value={training?.pace}
      />
    </div>

    <!-- Submit -->
    <div class="flex justify-center gap-4">
      <button
        type="submit"
        class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:shadow-outline disabled:opacity-50 disabled:cursor-not-allowed"
      >
        {submitButtonText}
      </button>
      
      <button
        id="cancel-edit-button"
        type="button"
        class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md focus:outline-none focus:shadow-outline"
      >
        Wróć
      </button>
    </div>

    <!-- Messages container -->
    <div id="msgContainer"></div>
  </div>
</form>

<script define:vars={{ initialTraining: training }}>
  const form = document.getElementById("trainingForm");
  const submitBtn = form.querySelector('button[type="submit"]');
  const select = document.getElementById("location");
  const linkInput = document.getElementById("locationLink");
  const msgContainer = document.getElementById("msgContainer");

  // update hidden link on selection change
  select.addEventListener("change", () => {
    const opt = select.selectedOptions[0];
    linkInput.value = opt?.dataset.link || "";
  });

  // If not in edit mode, reset form and populate link
  if (!initialTraining) {
    form.reset();
    select.dispatchEvent(new Event("change"));
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!form.checkValidity()) {
      form.reportValidity();
      return;
    }
    submitBtn.disabled = true;
    msgContainer.innerHTML = "";

    // build data, always include link
    const formData = new FormData(form);
    formData.set("locationLink", linkInput.value);
    const data = Object.fromEntries(formData.entries());

    const isUpdate = initialTraining && initialTraining.uid;
    const apiUrl = isUpdate ? "/api/update-training" : "/api/add-training";
    const apiMethod = isUpdate ? "PUT" : "POST";
    const successMessage = isUpdate
      ? "Trening zaktualizowany pomyślnie!"
      : "Trening został dodany!";
    const errorMessage = isUpdate
      ? "Nie udało się zaktualizować treningu. Sprawdź połączenie internetowe i upewnij się, że wszystkie pola są poprawnie wypełnione. Jeśli problem się powtarza, spróbuj odświeżyć stronę."
      : "Nie udało się dodać treningu. Sprawdź połączenie internetowe i upewnij się, że wszystkie wymagane pola są wypełnione. Jeśli problem się powtarza, napisz do Łysego.";

    try {
      const res = await fetch(apiUrl, {
        method: apiMethod,
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data),
      });

      if (!res.ok) {
        let specificError;
        
        if (res.status === 400) {
          specificError = isUpdate 
            ? "Dane treningu są nieprawidłowe. Sprawdź czy wszystkie pola są poprawnie wypełnione, szczególnie datę, dystans i tempo."
            : "Nie można dodać treningu - niektóre dane są nieprawidłowe. Sprawdź format daty, czy dystans jest liczbą dodatnią i czy tempo mieści się w dozwolonym zakresie.";
        } else if (res.status === 404) {
          specificError = "Trening nie został znaleziony. Możliwe, że został już usunięty przez innego użytkownika. Odśwież stronę i spróbuj ponownie.";
        } else if (res.status === 409) {
          specificError = "Konflikt danych - trening o podobnych parametrach już istnieje lub został zmodyfikowany przez innego użytkownika. Sprawdź listę treningów i spróbuj ponownie.";
        } else if (res.status >= 500) {
          specificError = isUpdate
            ? "Serwer ma obecnie problemy techniczne. Twoje zmiany nie zostały zapisane. Spróbuj ponownie za kilka minut."
            : "Serwer ma obecnie problemy techniczne. Trening nie został dodany. Spróbuj ponownie za kilka minut.";
        } else {
          specificError = errorMessage;
        }
        
        throw new Error(specificError);
      }

      const successMsg = document.createElement("div");
      successMsg.textContent = successMessage;
      successMsg.className = "mt-2 p-2 bg-green-100 text-green-800 rounded-md";
      msgContainer.appendChild(successMsg);

      if (!isUpdate) {
        form.reset();
        select.dispatchEvent(new Event("change"));
      } else {
        window.location.href = "/"; // Redirect to home after update
      }
    } catch (error) {
      const errorMsg = document.createElement("div");
      errorMsg.textContent = error.message || errorMessage;
      errorMsg.className = "mt-2 p-2 bg-red-100 text-red-800 rounded-md";
      msgContainer.appendChild(errorMsg);
    } finally {
      submitBtn.disabled = false;
    }
  });
</script>
